<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Data Mart Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">

    <!-- Navbar -->
    <nav class="bg-blue-600 p-4 shadow-lg">
        <div class="container mx-auto flex items-center justify-between">
            <div class="flex items-center text-white">
                <i class="fas fa-cloud-sun text-3xl mr-3"></i>
                <span class="font-bold text-xl">Weather Data Mart</span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto mt-8 px-4">
        
        <!-- Controls -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <label for="locationSelect" class="block text-gray-700 text-sm font-bold mb-2">Chọn Tỉnh/Thành phố:</label>
            <select id="locationSelect" class="block appearance-none w-full md:w-1/3 bg-gray-200 border border-gray-200 text-gray-700 py-3 px-4 pr-8 rounded leading-tight focus:outline-none focus:bg-white focus:border-gray-500">
                {% for key, name in locations.items() %}
                <option value="{{ key }}">{{ name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Info Cards (Dự báo mới nhất) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Card 1: Nhiệt độ -->
            <div class="bg-gradient-to-r from-orange-400 to-red-500 rounded-lg shadow-lg p-6 text-white">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-white bg-opacity-30 mr-4">
                        <i class="fas fa-temperature-high text-2xl"></i>
                    </div>
                    <div>
                        <p class="text-sm opacity-80">Nhiệt độ Dự báo (Hôm nay)</p>
                        <p class="text-2xl font-bold" id="currentTemp">--°C</p>
                        <p class="text-xs" id="tempRange">Min: -- / Max: --</p>
                    </div>
                </div>
            </div>

            <!-- Card 2: Tình trạng -->
            <div class="bg-gradient-to-r from-blue-400 to-blue-600 rounded-lg shadow-lg p-6 text-white">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-white bg-opacity-30 mr-4">
                        <i class="fas fa-cloud text-2xl"></i>
                    </div>
                    <div>
                        <p class="text-sm opacity-80">Tình trạng thời tiết</p>
                        <p class="text-xl font-bold truncate" id="currentDesc">--</p>
                        <p class="text-xs" id="rainStatus">--</p>
                    </div>
                </div>
            </div>

            <!-- Card 3: Ngày -->
            <div class="bg-gradient-to-r from-green-400 to-teal-500 rounded-lg shadow-lg p-6 text-white">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-white bg-opacity-30 mr-4">
                        <i class="fas fa-calendar-alt text-2xl"></i>
                    </div>
                    <div>
                        <p class="text-sm opacity-80">Ngày dự báo</p>
                        <p class="text-2xl font-bold" id="currentDate">--/--/----</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">
                <i class="fas fa-chart-line mr-2 text-blue-500"></i>
                Biểu đồ nhiệt độ 30 ngày tới - <span id="chartLocationName" class="text-blue-600">...</span>
            </h2>
            <div class="relative h-96 w-full">
                <canvas id="weatherChart"></canvas>
            </div>
        </div>

    </div>

    <!-- Footer -->
    <footer class="mt-12 bg-gray-800 text-white py-6 text-center">
        <p>Data Warehouse Project &copy; 2025</p>
    </footer>

    <!-- Script Logic -->
    <script>
        let myChart = null;

        // Hàm lấy dữ liệu từ API
        async function fetchWeatherData(locationKey) {
            try {
                const response = await fetch(`/api/weather?location_key=${locationKey}`);
                const result = await response.json();
                
                if(result.error) {
                    alert("Lỗi tải dữ liệu: " + result.error);
                    return;
                }

                updateDashboard(result);
            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }

        // Hàm cập nhật giao diện
        function updateDashboard(data) {
            const weatherList = data.data;
            const locationName = data.location;
            
            // 1. Cập nhật Text (Lấy ngày đầu tiên làm dự báo hiện tại)
            if (weatherList.length > 0) {
                const today = weatherList[0];
                document.getElementById('currentTemp').innerText = `${today.avg_temp}°C`;
                document.getElementById('tempRange').innerText = `Min: ${today.min_temp}°C / Max: ${today.max_temp}°C`;
                document.getElementById('currentDesc').innerText = today.desc;
                document.getElementById('rainStatus').innerText = today.rain ? "Có khả năng mưa" : "Không mưa";
                document.getElementById('currentDate').innerText = today.date;
                document.getElementById('chartLocationName').innerText = locationName;
            }

            // 2. Cập nhật Biểu đồ
            updateChart(weatherList);
        }

        // Hàm vẽ biểu đồ
        function updateChart(weatherList) {
            const ctx = document.getElementById('weatherChart').getContext('2d');
            
            // Chuẩn bị dữ liệu cho Chart.js
            const labels = weatherList.map(item => item.date);
            const maxTemps = weatherList.map(item => item.max_temp);
            const minTemps = weatherList.map(item => item.min_temp);

            if (myChart) {
                myChart.destroy(); // Xóa biểu đồ cũ
            }

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Nhiệt độ Cao nhất (°C)',
                            data: maxTemps,
                            borderColor: 'rgba(239, 68, 68, 1)', // Red
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Nhiệt độ Thấp nhất (°C)',
                            data: minTemps,
                            borderColor: 'rgba(59, 130, 246, 1)', // Blue
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + '°C';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'Độ C' }
                        }
                    }
                }
            });
        }

        // Event Listener: Khi đổi tỉnh thành
        document.getElementById('locationSelect').addEventListener('change', function() {
            fetchWeatherData(this.value);
        });

        // Khởi chạy lần đầu (Mặc định HCM)
        fetchWeatherData('353981');

    </script>
</body>
</html>