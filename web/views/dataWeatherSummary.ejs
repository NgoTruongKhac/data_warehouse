<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title><%= pageTitle %></title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="container py-4">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Trang chủ</a></li>
        <li class="breadcrumb-item active">Báo cáo tổng hợp</li>
      </ol>
    </nav>

    <h2 class="mb-4">Tổng hợp thời tiết hàng tháng theo Tỉnh/Thành</h2>

    <div class="row">
      <!-- Biểu đồ Cột: Số ngày mưa -->
      <div class="col-md-6">
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            Số ngày mưa (Total Rainy Days)
          </div>
          <div class="card-body">
            <canvas id="rainChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Biểu đồ Đường: Nhiệt độ trung bình -->
      <div class="col-md-6">
        <div class="card mb-4">
          <div class="card-header bg-danger text-white">
            Nhiệt độ TB (Avg Temp °F)
          </div>
          <div class="card-body">
            <canvas id="tempAvgChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <script>
      // 1. Nhận dữ liệu từ Server
      const rawData = <%- JSON.stringify(data) %>;

      // 2. Cấu hình Mapping tên và màu sắc cho từng Location Key
      const locationConfig = {
        '353412': { name: 'Hà Nội', color: 'rgba(255, 99, 132, 1)', bg: 'rgba(255, 99, 132, 0.6)' },
        '353981': { name: 'Đà Nẵng', color: 'rgba(54, 162, 235, 1)', bg: 'rgba(54, 162, 235, 0.6)' },
        '427264': { name: 'TP. HCM', color: 'rgba(255, 206, 86, 1)', bg: 'rgba(255, 206, 86, 0.6)' }
      };

      // Hàm helper để lấy tên hiển thị (Fallback nếu key lạ)
      const getLocationName = (key) => locationConfig[key]?.name || key;

      // 3. Xử lý dữ liệu (Pivot Data)
      // Lấy danh sách tháng duy nhất (trục X)
      const uniqueMonths = [...new Set(rawData.map(item => item.month_sk))].sort((a, b) => a - b);
      
      //format month_sk to MM/YYYY
      const formatMonthSk = (monthSk) => {
        if (!monthSk) return "";
        const str = monthSk.toString();
        if (str.length !== 6) return str;
      return `${str.substring(4, 6)}/${str.substring(0, 4)}`;
      };
      const labels = uniqueMonths.map(formatMonthSk);
      
      // Lấy danh sách location key duy nhất
      const uniqueKeys = [...new Set(rawData.map(item => item.location_key))];

      // Tạo Datasets cho biểu đồ Mưa (Bar)
      const rainDatasets = uniqueKeys.map(key => {
        return {
          label: getLocationName(key),
          data: uniqueMonths.map(month => {
            // Tìm dòng dữ liệu khớp tháng và key
            const record = rawData.find(r => r.month_sk === month && r.location_key === key);
            return record ? record.total_rainy_days : 0;
          }),
          backgroundColor: locationConfig[key]?.bg || 'gray',
          borderColor: locationConfig[key]?.color || 'black',
          borderWidth: 1
        };
      });

      // Tạo Datasets cho biểu đồ Nhiệt độ (Line)
      const tempDatasets = uniqueKeys.map(key => {
        return {
          label: getLocationName(key),
          data: uniqueMonths.map(month => {
            const record = rawData.find(r => r.month_sk === month && r.location_key === key);
            return record ? record.avg_temp_c : 0;
          }),
          borderColor: locationConfig[key]?.color || 'black',
          backgroundColor: locationConfig[key]?.bg || 'gray',
          tension: 0.3, // Làm mượt đường vẽ
          fill: false
        };
      });

      // 4. Vẽ biểu đồ

      // --- Biểu đồ Mưa (Grouped Bar Chart) ---
      new Chart(document.getElementById('rainChart'), {
          type: 'bar',
          data: {
              labels: labels,
              datasets: rainDatasets
          },
          options: {
              responsive: true,
              plugins: {
                  title: { display: false },
                  tooltip: { mode: 'index', intersect: false } // Hiển thị tooltip gộp
              },
              scales: {
                  y: { beginAtZero: true, title: { display: true, text: 'Ngày' } }
              }
          }
      });

      // --- Biểu đồ Nhiệt độ (Multi-Line Chart) ---
      new Chart(document.getElementById('tempAvgChart'), {
          type: 'line',
          data: {
              labels: labels,
              datasets: tempDatasets
          },
          options: {
              responsive: true,
              plugins: {
                  title: { display: false },
                  tooltip: { mode: 'index', intersect: false }
              },
              scales: {
                  y: { beginAtZero: false, title: { display: true, text: 'Độ F' } } // Nhiệt độ không cần bắt đầu từ 0 cho dễ nhìn biến động
              }
          }
      });
    </script>
  </body>
</html>
